<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="orderMapper">

    <resultMap id="orderWithReviewMap" type="com.fastcampus.gearshift.dto.SOrderDto">
        <id property="orderId" column="order_id"/>
        <result property="orderCompletedDate" column="order_completed_date"/>
        <result property="carInfoId" column="car_info_id"/>
        <result property="modelName" column="model_name"/>
        <result property="reviewStatus" column="review_status"/>

        <!-- Nested ReviewDto -->
        <association property="review" javaType="com.fastcampus.gearshift.dto.ReviewDto">
            <result property="reviewTitle" column="review_title"/>
            <result property="reviewContent" column="review_content"/>
            <result property="rating" column="rating"/>
            <result property="createdAt" column="created_at"/>
            <result property="updatedAt" column="updated_at"/>
        </association>
    </resultMap>


    <select id="selectCompletedOrdersWithReviewStatus" resultMap="orderWithReviewMap" parameterType="java.lang.Integer">
        SELECT
            o.order_id
            , o.car_info_id
            , i.model_name
            , o.order_completed_date
            , CASE
                  WHEN r.order_id IS NOT NULL THEN 'Y'
                ELSE 'N'
                END AS review_status
            , r.review_title
            , r.review_content
            , r.rating
            , r.created_at
            , r.updated_at
        FROM orders o
                 LEFT JOIN review r ON o.order_id = r.order_id AND r.is_deleted = 0
                 LEFT JOIN information i ON o.car_info_id = i.car_info_id
        WHERE o.user_id = #{userId}
          AND o.order_status = '주문완료'
        ORDER BY o.order_id DESC
    </select>

</mapper>