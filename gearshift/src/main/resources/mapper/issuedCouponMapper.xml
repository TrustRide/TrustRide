<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="issuedCouponMapper">

    <!-- 특정 사용자(UserId)의 보유 쿠폰 목록 조회 -->
    <select id="findByUserId" resultType="issuedCouponDto">
        SELECT * FROM issued_coupon WHERE user_id = #{userId} ORDER BY issue_date DESC
    </select>

    <!-- 쿠폰 사용 처리 -->
    <update id="useIssuedCoupon">
        UPDATE issued_coupon
        SET is_used = TRUE, used_date = NOW()
        WHERE issued_id = #{issuedId} AND user_id = #{userId} AND is_used = FALSE
    </update>

    <!-- 전체 사용자에게 선택된 쿠폰 지급 -->
    <insert id="insertIssuedCoupons">
        INSERT INTO issued_coupon (issue_date, is_used, used_date, coupon_id, user_id)
        VALUES
        <foreach collection="issuedCoupons" item="coupon" separator=",">
            (NOW(), FALSE, NULL, #{coupon.couponId}, #{coupon.userId})
        </foreach>
    </insert>


    <select id="findAllUserIds" resultType="Integer">
        SELECT user_id
        FROM user

    </select>



</mapper>
